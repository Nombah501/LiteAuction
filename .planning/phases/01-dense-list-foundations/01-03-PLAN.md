---
phase: 01-dense-list-foundations
plan: "03"
type: execute
wave: 3
depends_on:
  - 01-01
  - 01-02
files_modified:
  - app/web/dense_list.py
  - app/web/main.py
  - app/services/admin_list_preferences_service.py
  - tests/test_web_dense_list_contract.py
  - tests/integration/test_web_dense_list_foundations.py
autonomous: true
requirements:
  - LAYT-01
  - LAYT-02
  - LAYT-03
  - DENS-02
must_haves:
  truths:
    - "Operators can show/hide queue columns without breaking table rendering."
    - "Operators can reorder columns and pin chosen columns for stable left-side scanning."
    - "Density and column layout choices remain applied after refresh and after a new authenticated session."
  artifacts:
    - path: app/web/dense_list.py
      provides: "Column layout state helpers, sticky pin offset logic, and client event handling script."
      contains: "visible|order|pinned|pin-left"
    - path: app/web/main.py
      provides: "Queue routes load saved preferences and expose endpoint/action to persist layout updates."
      contains: "admin_list_preferences"
    - path: tests/integration/test_web_dense_list_foundations.py
      provides: "End-to-end verification for show/hide, reorder, pin, and persistence restoration."
      contains: "show/hide|reorder|pin|persist"
  key_links:
    - from: app/web/main.py
      to: app/services/admin_list_preferences_service.py
      via: "Route GET loads defaults+saved state; POST persists validated state per subject+queue"
      pattern: "load_admin_list_preference|save_admin_list_preference"
    - from: app/web/dense_list.py
      to: app/web/main.py
      via: "Rendered table cells use column keys consumed by visibility/order/pinning script"
      pattern: "data-col"
    - from: app/web/dense_list.py
      to: tests/test_web_dense_list_contract.py
      via: "Sticky offset recalculation and pin classes validated by contract tests"
      pattern: "is-pinned|--pin-left"
---

<objective>
Deliver full queue table layout controls (show/hide, reorder, pin) and complete persistence wiring for density plus layout state.

Purpose: Complete Phase 1 outcomes so operators can customize high-density queue scanning and keep those choices over time.
Output: Layout controls, preference save/load wiring, and regression tests proving persistence across sessions.
</objective>

<execution_context>
@/home/n501/.config/opencode/get-shit-done/workflows/execute-plan.md
@/home/n501/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-dense-list-foundations/01-RESEARCH.md
@.planning/phases/01-dense-list-foundations/01-01-PLAN.md
@.planning/phases/01-dense-list-foundations/01-02-PLAN.md
@app/web/main.py
@app/services/admin_list_preferences_service.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement column visibility, order, and pin interaction layer</name>
  <files>app/web/dense_list.py, app/web/main.py</files>
  <action>Add queue toolbar controls to toggle column visibility, reorder columns, and pin selected columns to the left with sticky positioning. Ensure every visibility/order change recomputes pin offsets to avoid overlap and preserve readability; do not hardcode fixed offsets.</action>
  <verify>python -m pytest -q tests/test_web_dense_list_contract.py -k "column or pin or order"</verify>
  <done>Operators can show/hide, reorder, and pin columns on queue tables with stable sticky alignment.</done>
</task>

<task type="auto">
  <name>Task 2: Wire layout and density persistence into queue render/action flow</name>
  <files>app/web/main.py, app/services/admin_list_preferences_service.py</files>
  <action>On queue GET routes, load saved preferences by authenticated subject and queue key, merge with safe defaults, and render resulting density/layout state. Add/update a CSRF-protected server action endpoint that accepts validated preference payloads and saves through the preference service; keep RBAC trust boundaries unchanged and reject malformed payloads with clear 400 responses.</action>
  <verify>RUN_INTEGRATION_TESTS=1 TEST_DATABASE_URL=postgresql+asyncpg://.../auction_test python -m pytest -q tests/integration/test_web_dense_list_foundations.py -k "persistence or session or subject"</verify>
  <done>Saved density/layout state is restored for same operator after refresh/new session and isolated across operators.</done>
</task>

<task type="auto">
  <name>Task 3: Harden end-to-end dense-list regression coverage</name>
  <files>tests/test_web_dense_list_contract.py, tests/integration/test_web_dense_list_foundations.py</files>
  <action>Expand integration tests to cover full Phase 1 flow: apply layout changes, persist state, reload queue route, and confirm restored visibility/order/pin + density. Add negative tests for unknown column keys and invalid density so unsafe payloads cannot persist.</action>
  <verify>RUN_INTEGRATION_TESTS=1 TEST_DATABASE_URL=postgresql+asyncpg://.../auction_test python -m pytest -q tests/test_web_dense_list_contract.py tests/integration/test_web_dense_list_foundations.py</verify>
  <done>Automated tests enforce LAYT-01/02/03 and DENS-02 behaviors, including invalid payload rejection paths.</done>
</task>

</tasks>

<verification>
Run dense-list contract tests and DB-backed integration tests validating layout interactions and persistence across sessions.
</verification>

<success_criteria>
Operators can fully customize table layout and density on queue pages, and those preferences reliably persist per operator across sessions.
</success_criteria>

<output>
After completion, create `.planning/phases/01-dense-list-foundations/01-dense-list-foundations-03-SUMMARY.md`
</output>
