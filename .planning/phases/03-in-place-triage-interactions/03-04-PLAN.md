---
phase: 03-in-place-triage-interactions
plan: "04"
type: execute
wave: 1
depends_on:
  - 03-03
files_modified:
  - app/web/dense_list.py
  - app/web/main.py
  - tests/integration/test_web_triage_interactions.py
  - tests/test_web_dense_list_contract.py
autonomous: true
requirements:
  - DISC-02
  - DISC-03
  - KEYB-01
  - BULK-01
gap_closure: true
must_haves:
  truths:
    - "Closing details restores focus and preserves scroll position for continued triage."
    - "Section-level failures keep successful sections visible and provide inline retry for failed sections."
    - "Keyboard shortcuts let operators focus quick search, move row focus, and toggle active row details without leaving queue context."
    - "Bulk execution reports per-row outcomes so operators can continue with unresolved items in place."
    - "Integration tests ensure unauthorized or invalid bulk mutations fail safely."
  artifacts:
    - path: app/web/dense_list.py
      provides: "Client behavior for focus/scroll restoration, keyboard row navigation, section retry hydration, and bulk result rendering."
      contains: "focusedRowId|toggleDetail|fetchSection|bulk"
    - path: app/web/main.py
      provides: "Bulk result payload contract that supports row-level UI updates and failure visibility."
      contains: "actions/triage/bulk|results"
    - path: tests/integration/test_web_triage_interactions.py
      provides: "Behavioral assertions for keyboard outcomes and 401/403 bulk safety paths."
      contains: "keyboard|401|403|bulk"
    - path: tests/test_web_dense_list_contract.py
      provides: "Contract checks for keyboard markers and retry/bulk outcome hooks."
      contains: "shortcut|retry|bulk"
  key_links:
    - from: app/web/dense_list.py
      to: app/web/main.py
      via: "Retry actions re-fetch section payload and re-render target section inline without dropping successful sections."
      pattern: "fetchSection.*section"
    - from: app/web/dense_list.py
      to: app/web/main.py
      via: "Bulk POST response results are parsed and applied to row status and unresolved-item messaging."
      pattern: "actions/triage/bulk|results"
    - from: tests/integration/test_web_triage_interactions.py
      to: app/web/main.py
      via: "Integration tests assert unauthorized and forbidden bulk mutations fail with 401/403 and no unintended updates."
      pattern: "401|403|csrf|forbidden"
---

<objective>
Close all failed and partial Phase 3 truths by wiring missing dense-list interactions and adding regression coverage for keyboard and bulk safety behavior.

Purpose: Convert the current scaffolded triage UX into complete in-place behavior so operators can continue triage without context loss after detail toggles, section retries, and bulk operations.
Output: Updated dense-list interaction script, bulk outcome rendering path, and integration/contract tests proving gap closure.
</objective>

<execution_context>
@/home/n501/.config/opencode/get-shit-done/workflows/execute-plan.md
@/home/n501/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/phases/03-in-place-triage-interactions/03-CONTEXT.md
@.planning/phases/03-in-place-triage-interactions/03-VERIFICATION.md
@.planning/phases/03-in-place-triage-interactions/03-in-place-triage-interactions-03-SUMMARY.md
@app/web/dense_list.py
@app/web/main.py
@tests/integration/test_web_triage_interactions.py
@tests/test_web_dense_list_contract.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Complete context retention and keyboard triage choreography</name>
  <files>app/web/dense_list.py, tests/integration/test_web_triage_interactions.py, tests/test_web_dense_list_contract.py</files>
  <action>Implement close-path focus and scroll restoration by tracking the invoking toggle element/row and list scroll offset before expansion, then restoring both on close while preserving active filters. Implement roving focused-row index across visible triage rows so `j/k` move focus deterministically and `o/Enter` toggle details for the focused row (while still suppressing shortcuts inside editable controls). Add runtime and contract assertions for `j/k/o/Enter` outcomes and boundary no-op behavior. Evidence mapping: `03-VERIFICATION.md` lines 71, 74, 117, 120 and gap entries lines 7-15, 25-36.</action>
  <verify>RUN_INTEGRATION_TESTS=1 TEST_DATABASE_URL=postgresql+asyncpg://.../auction_test python -m pytest -q tests/test_web_dense_list_contract.py tests/integration/test_web_triage_interactions.py -k "keyboard or focus or scroll"</verify>
  <done>Closing detail rows returns operator focus to the invoking control, preserves scroll position, and keyboard shortcuts execute row navigation/toggle actions rather than only preventing defaults.</done>
</task>

<task type="auto">
  <name>Task 2: Wire retry hydration and per-row bulk outcome rendering</name>
  <files>app/web/dense_list.py, app/web/main.py</files>
  <action>Update section retry handler to consume `fetchSection(rowId, section)` payload and patch the corresponding failed section DOM with returned HTML or inline error state on repeated failure; keep successfully loaded sections untouched. Parse and apply JSON `results` from `/actions/triage/bulk` to render per-row success/failure summaries inline, update status cells for successful rows, and leave failed rows visibly actionable in place with reason text. Keep implementation aligned with existing inline two-level list+details model from context decisions. Evidence mapping: `03-VERIFICATION.md` lines 73, 77, 96, 98, 118, 119 and gap entries lines 16-24, 37-45.</action>
  <verify>python -m pytest -q tests/test_web_dense_list_contract.py -k "retry or bulk"</verify>
  <done>Retry clicks update the failed section inline from real response payloads, repeated retry failures show inline messaging, and bulk actions surface row-level outcomes without forcing operators out of queue context.</done>
</task>

<task type="auto">
  <name>Task 3: Add bulk mutation safety assertions for unauthorized and forbidden paths</name>
  <files>tests/integration/test_web_triage_interactions.py</files>
  <action>Add integration tests that explicitly assert `POST /actions/triage/bulk` returns 401 for unauthorized actor and 403 for forbidden scope or failed CSRF conditions, and confirm no row mutations are applied in those branches. Keep existing confirmation-mismatch and mixed-results tests intact, extending them only where needed to validate safe-failure behavior. Evidence mapping: `03-VERIFICATION.md` lines 47-53, 87, 99 and gap entries lines 46-53.</action>
  <verify>RUN_INTEGRATION_TESTS=1 TEST_DATABASE_URL=postgresql+asyncpg://.../auction_test python -m pytest -q tests/integration/test_web_triage_interactions.py -k "bulk and (401 or 403 or csrf or unauthorized or forbidden)"</verify>
  <done>Integration suite proves invalid bulk mutations fail safely with expected auth/CSRF codes and no unintended state changes.</done>
</task>

</tasks>

<verification>
Run dense-list contract tests and triage integration tests for keyboard behavior, focus/scroll restoration, retry rehydration, per-row bulk outcomes, and 401/403 bulk safety checks.
</verification>

<success_criteria>
All failed/partial truths in `03-VERIFICATION.md` are covered by executable tasks and verifiable tests, with no remaining blocker-level gaps tied to `app/web/dense_list.py` interaction wiring.
</success_criteria>

<output>
After completion, create `.planning/phases/03-in-place-triage-interactions/03-in-place-triage-interactions-04-SUMMARY.md`
</output>
