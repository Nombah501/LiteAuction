---
phase: 03-in-place-triage-interactions
plan: "03"
type: execute
wave: 3
depends_on:
  - 03-01
  - 03-02
files_modified:
  - app/web/main.py
  - app/web/dense_list.py
  - tests/test_web_dense_list_contract.py
  - tests/integration/test_web_triage_interactions.py
autonomous: true
requirements:
  - BULK-01
must_haves:
  truths:
    - "Operators can select multiple rows and run supported bulk triage actions from the queue without leaving context."
    - "Destructive bulk operations require explicit confirmation text before server action executes."
    - "Bulk execution reports per-row outcomes so operators can continue with unresolved items in place."
  artifacts:
    - path: app/web/dense_list.py
      provides: "Client-side multi-select state, bulk action toolbar, and confirmation workflow."
      contains: "data-bulk-select|data-bulk-action|confirm"
    - path: app/web/main.py
      provides: "CSRF-protected bulk action endpoint validating queue scope, permissions, and per-row results."
      contains: "bulk action|selected_ids|results"
    - path: tests/integration/test_web_triage_interactions.py
      provides: "End-to-end coverage for safe bulk actions, destructive confirmation, and partial success reporting."
      contains: "bulk|confirm|partial success"
  key_links:
    - from: app/web/dense_list.py
      to: app/web/main.py
      via: "Bulk toolbar posts selected ids and chosen action; server returns row-level outcomes for in-place updates."
      pattern: "selected_ids|bulk_action|results"
    - from: tests/integration/test_web_triage_interactions.py
      to: app/web/main.py
      via: "Integration tests ensure unauthorized or invalid bulk mutations fail safely."
      pattern: "401|403|validation"
---

<objective>
Deliver queue-native batch triage actions with explicit safety confirmations and clear result feedback.

Purpose: Complete BULK-01 on top of inline disclosure and keyboard foundation.
Output: Bulk-selection UX, secure bulk action endpoint, and tests for destructive confirmation and mixed-result handling.
</objective>

<execution_context>
@/home/n501/.config/opencode/get-shit-done/workflows/execute-plan.md
@/home/n501/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-in-place-triage-interactions/03-CONTEXT.md
@.planning/phases/03-in-place-triage-interactions/03-RESEARCH.md
@.planning/phases/03-in-place-triage-interactions/03-01-PLAN.md
@.planning/phases/03-in-place-triage-interactions/03-02-PLAN.md
@app/web/main.py
@app/web/dense_list.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add multi-row selection and bulk action toolbar</name>
  <files>app/web/main.py, app/web/dense_list.py</files>
  <action>Add per-row selection controls and a context-aware bulk toolbar for supported actions (e.g., resolve/reopen flows that already exist per queue policy). Keep selection state visible while details are expanded, allow select-all-on-page behavior, and preserve row focus after bulk execution updates.</action>
  <verify>python -m pytest -q tests/test_web_dense_list_contract.py -k "bulk and toolbar"</verify>
  <done>Operators can select multiple rows and trigger supported queue bulk actions from in-place triage UI.</done>
</task>

<task type="auto">
  <name>Task 2: Implement destructive confirmation and secure bulk endpoint</name>
  <files>app/web/main.py, app/web/dense_list.py</files>
  <action>Create a CSRF-protected bulk action endpoint that validates queue key, selected ids, and role permissions before mutating any records. For destructive actions, require explicit confirmation text in client flow before submit. Return per-row success/failure results with reason codes so unresolved rows remain actionable in the same list view.</action>
  <verify>RUN_INTEGRATION_TESTS=1 TEST_DATABASE_URL=postgresql+asyncpg://.../auction_test python -m pytest -q tests/integration/test_web_triage_interactions.py -k "bulk and (confirm or security)"</verify>
  <done>Destructive bulk actions are gated by confirmation and protected by server-side validation and authorization checks.</done>
</task>

<task type="auto">
  <name>Task 3: Finalize end-to-end triage interaction coverage</name>
  <files>tests/test_web_dense_list_contract.py, tests/integration/test_web_triage_interactions.py</files>
  <action>Expand test coverage for complete Phase 3 flow: open inline details, progressive section behavior, keyboard navigation, multi-select, destructive bulk confirmation, and mixed-result handling. Add regression checks that list filters, density, and scroll/focus context remain stable after bulk operations.</action>
  <verify>RUN_INTEGRATION_TESTS=1 TEST_DATABASE_URL=postgresql+asyncpg://.../auction_test python -m pytest -q tests/test_web_dense_list_contract.py tests/integration/test_web_triage_interactions.py</verify>
  <done>Automated tests cover DISC/KEYB/BULK interaction chains and prevent queue-context-loss regressions.</done>
</task>

</tasks>

<verification>
Run dense-list contract tests and triage integration suite validating batch safety, confirmation gates, and context retention after bulk operations.
</verification>

<success_criteria>
Batch triage actions are available, safe, and transparent: operators can process multiple rows quickly with explicit destructive confirmations and row-level outcome feedback.
</success_criteria>

<output>
After completion, create `.planning/phases/03-in-place-triage-interactions/03-in-place-triage-interactions-03-SUMMARY.md`
</output>
