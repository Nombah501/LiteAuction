---
phase: 02-workflow-presets
plan: "01"
type: execute
wave: 1
depends_on: []
files_modified:
  - app/db/models.py
  - alembic/versions/0037_workflow_presets.py
  - app/services/admin_queue_presets_service.py
  - tests/test_admin_queue_presets_service.py
autonomous: true
requirements:
  - PSET-01
  - PSET-03
must_haves:
  truths:
    - "Operators and admins can create personal named presets with validated names and full queue view snapshots."
    - "Preset ownership is enforced so only owners or admins can update/delete a personal preset."
    - "Each moderation context can store exactly one admin default preset target."
  artifacts:
    - path: app/db/models.py
      provides: "Workflow preset persistence entities for named presets, selection state, and admin defaults."
      contains: "AdminQueuePreset|AdminQueuePresetDefault|AdminQueuePresetSelection"
    - path: alembic/versions/0037_workflow_presets.py
      provides: "Backward-safe schema migration for preset and default tables with constraints/indexes."
      contains: "workflow presets"
    - path: app/services/admin_queue_presets_service.py
      provides: "Preset lifecycle and policy service including name validation and ownership checks."
      exports: ["save_preset", "update_preset", "delete_preset", "set_admin_default"]
  key_links:
    - from: app/services/admin_queue_presets_service.py
      to: app/db/models.py
      via: "Service uses ORM entities and conflict-safe writes for named preset lifecycle."
      pattern: "insert\(|on_conflict_do_update|select\(AdminQueuePreset"
    - from: alembic/versions/0037_workflow_presets.py
      to: app/db/models.py
      via: "Migration schema aligns with ORM constraints and uniqueness contracts."
      pattern: "UniqueConstraint|queue_context|owner_subject_key"
---

<objective>
Build the workflow-preset persistence and policy foundation so Phase 2 can safely support named presets and admin defaults.

Purpose: Establish explicit server-side concepts for preset lifecycle and context defaults before route/UI wiring.
Output: New preset schema, migration, and service-level APIs with ownership/name-validation test coverage.
</objective>

<execution_context>
@/home/n501/.config/opencode/get-shit-done/workflows/execute-plan.md
@/home/n501/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-workflow-presets/02-CONTEXT.md
@.planning/phases/02-workflow-presets/02-RESEARCH.md
@app/db/models.py
@app/services/admin_list_preferences_service.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add workflow preset and default persistence schema</name>
  <files>app/db/models.py, alembic/versions/0037_workflow_presets.py</files>
  <action>Create dedicated persistence entities for named presets, user context selection state, and one admin default per queue context. Enforce `name` length 1-40 and unique-name semantics per owner/context, and include explicit context keys for `moderation`, `appeals`, `risk`, and `feedback` mapped to queue keys (`complaints`, `appeals`, `signals`, `trade_feedback`). Add downgrade-safe migration with indexes needed for owner lookup, context default lookup, and active selection resolution.</action>
  <verify>alembic upgrade head && alembic downgrade -1 && alembic upgrade head</verify>
  <done>Schema migration is reversible and creates all preset/default tables and constraints required for lifecycle + admin default policy.</done>
</task>

<task type="auto">
  <name>Task 2: Implement preset lifecycle and policy service</name>
  <files>app/services/admin_queue_presets_service.py</files>
  <action>Implement a new service that validates strict save payloads (`density`, `columns`, filter/sort keys), supports both update-current and save-as-new flows, handles duplicate-name overwrite vs new-save branching, and enforces owner/admin update/delete authorization. Include deterministic precedence helpers for first-entry default, last-selected reuse, reset-to-default behavior, and delete-active metadata (`was_active`, fallback target) needed by client prompts.</action>
  <verify>python -m pytest -q tests/test_admin_queue_presets_service.py -k "validation or ownership or duplicate or precedence"</verify>
  <done>Service can persist named presets, resolve defaults/selection deterministically, and reject invalid save payloads or unauthorized writes.</done>
</task>

<task type="auto">
  <name>Task 3: Add unit coverage for schema and policy invariants</name>
  <files>tests/test_admin_queue_presets_service.py</files>
  <action>Add unit tests for 1-40 name validation, duplicate-name overwrite behavior, owner/admin mutation rules, queue context mapping constants, and precedence transitions (first-entry default, subsequent last-selected). Include delete-active response contract tests that verify server emits enough context for keep-current vs revert-default client branch.</action>
  <verify>python -m pytest -q tests/test_admin_queue_presets_service.py</verify>
  <done>Unit tests lock core policy behavior and fail if validation/ownership/precedence contracts regress.</done>
</task>

</tasks>

<verification>
Run migration round-trip and service unit tests covering validation, lifecycle branching, and precedence rules.
</verification>

<success_criteria>
Preset persistence primitives exist with deterministic policy behavior and automated tests that protect name, ownership, and default mapping constraints.
</success_criteria>

<output>
After completion, create `.planning/phases/02-workflow-presets/02-workflow-presets-01-SUMMARY.md`
</output>
