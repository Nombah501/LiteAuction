---
phase: 02-workflow-presets
plan: "03"
type: execute
wave: 3
depends_on:
  - 02-01
  - 02-02
files_modified:
  - app/web/dense_list.py
  - app/web/main.py
  - tests/test_web_dense_list_contract.py
  - tests/integration/test_web_workflow_presets.py
autonomous: true
requirements:
  - PSET-01
  - PSET-02
  - PSET-03
must_haves:
  truths:
    - "Operator can save named presets via suggested name, save-as-new, and update-current flows with duplicate-name branching."
    - "Switching presets prompts when unsaved changes exist, and active preset shows a modified indicator when diverged."
    - "Deleting the active preset prompts operator to keep current state or revert to queue default, then applies chosen branch."
  artifacts:
    - path: app/web/dense_list.py
      provides: "Client interaction handlers for preset naming, switch confirm, modified marker, and delete-active branching UX."
      contains: "save as new|update current|modified|delete active"
    - path: app/web/main.py
      provides: "Endpoint responses returning conflict/delete-active metadata consumed by client decision prompts."
      contains: "overwrite|was_active|fallback"
    - path: tests/integration/test_web_workflow_presets.py
      provides: "End-to-end assertions for save/update/switch/delete UX contracts and resulting queue state."
      contains: "duplicate name|unsaved|delete active"
  key_links:
    - from: app/web/dense_list.py
      to: app/web/main.py
      via: "Client actions call preset endpoints and branch on conflict/active-delete response metadata."
      pattern: "save|update|delete|was_active|overwrite"
    - from: app/web/dense_list.py
      to: tests/test_web_dense_list_contract.py
      via: "Contract tests verify modified indicator and confirmation hooks are rendered."
      pattern: "data-preset-modified|data-preset-confirm"
---

<objective>
Complete operator-facing preset UX flows so save/apply/update/delete behavior matches locked decisions and is regression-protected.

Purpose: Deliver reliable state-change safeguards (confirmation and modified markers) so operators trust preset switching and deletion.
Output: Dense-list client interaction updates, route response refinements, and full save/apply/delete workflow tests.
</objective>

<execution_context>
@/home/n501/.config/opencode/get-shit-done/workflows/execute-plan.md
@/home/n501/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-workflow-presets/02-CONTEXT.md
@.planning/phases/02-workflow-presets/02-RESEARCH.md
@.planning/phases/02-workflow-presets/02-02-PLAN.md
@app/web/dense_list.py
@app/web/main.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement preset save/update/delete UX interactions</name>
  <files>app/web/dense_list.py, app/web/main.py</files>
  <action>Add client flow for suggested preset name (editable), explicit `Update current preset` and `Save as new preset` actions, and duplicate-name conflict prompt offering overwrite or new-save. Ensure server responses include conflict metadata and endpoint behavior remains strict on invalid save payloads while preserving CSRF and RBAC checks.</action>
  <verify>python -m pytest -q tests/test_web_dense_list_contract.py -k "preset and (save or update or duplicate)"</verify>
  <done>Operators can complete save/update flows with deterministic duplicate-name handling and no silent overwrites.</done>
</task>

<task type="auto">
  <name>Task 2: Add modified-state and safe-switch/delete guards</name>
  <files>app/web/dense_list.py, app/web/main.py</files>
  <action>Implement normalized current-state vs active-preset diffing to drive a visible modified indicator and unsaved-change confirmation before preset switching. On active preset delete, surface a client decision to keep current on-screen state or revert to context default, then call corresponding server branch using delete metadata (`was_active`, fallback/default payload) returned by API.</action>
  <verify>RUN_INTEGRATION_TESTS=1 TEST_DATABASE_URL=postgresql+asyncpg://.../auction_test python -m pytest -q tests/integration/test_web_workflow_presets.py -k "modified or unsaved or delete"</verify>
  <done>Preset switching/deletion never discards view state silently, and modified status reflects normalized state divergence only.</done>
</task>

<task type="auto">
  <name>Task 3: Finalize regression coverage for full preset lifecycle</name>
  <files>tests/test_web_dense_list_contract.py, tests/integration/test_web_workflow_presets.py</files>
  <action>Expand tests to cover full Phase 2 user flow: save new preset, update existing preset, load preset immediate apply, modified indicator transitions, unsaved switch confirmation, and active preset delete keep-vs-revert branch. Add security checks confirming non-owner non-admin users cannot mutate another user's presets or admin defaults.</action>
  <verify>RUN_INTEGRATION_TESTS=1 TEST_DATABASE_URL=postgresql+asyncpg://.../auction_test python -m pytest -q tests/test_web_dense_list_contract.py tests/integration/test_web_workflow_presets.py</verify>
  <done>Automated coverage demonstrates PSET-01/02/03 lifecycle behavior and prevents regressions in state-loss and authorization edge cases.</done>
</task>

</tasks>

<verification>
Run dense-list contract tests and end-to-end preset integration tests including security and state-safety branches.
</verification>

<success_criteria>
Preset UX behavior is complete and safe: named save lifecycle, immediate apply, modified-state prompts, and active-delete choice all work with test-backed confidence.
</success_criteria>

<output>
After completion, create `.planning/phases/02-workflow-presets/02-workflow-presets-03-SUMMARY.md`
</output>
