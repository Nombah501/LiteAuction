---
phase: 02-workflow-presets
plan: "02"
type: execute
wave: 2
depends_on:
  - 02-01
files_modified:
  - app/web/main.py
  - app/web/dense_list.py
  - tests/integration/test_web_workflow_presets.py
autonomous: true
requirements:
  - PSET-02
  - PSET-03
must_haves:
  truths:
    - "Opening Moderation, Appeals, Risk, and Feedback queues follows deterministic precedence: first-entry admin default, then last-selected preset."
    - "Selecting a preset applies immediately and queue state updates from persisted payload values."
    - "If preset payload contains stale fields, valid parts still apply and operator sees a short notice."
  artifacts:
    - path: app/web/main.py
      provides: "Preset-aware queue routes and JSON action endpoints for apply/select/default/reset flows."
      contains: "workflow preset"
    - path: app/web/dense_list.py
      provides: "Dense-list render contract extensions exposing preset metadata and notice slots."
      contains: "preset"
    - path: tests/integration/test_web_workflow_presets.py
      provides: "DB-backed route tests for apply/default precedence and tolerant stale-field behavior."
      contains: "first-entry|last-selected|partial-apply"
  key_links:
    - from: app/web/main.py
      to: app/services/admin_queue_presets_service.py
      via: "Queue route load path resolves active preset/default and action handlers persist selection changes."
      pattern: "resolve|select|reset|admin default"
    - from: app/web/dense_list.py
      to: app/web/main.py
      via: "Template output consumes preset payload and active selection metadata generated by routes."
      pattern: "data-active-preset|data-preset-notice"
---

<objective>
Wire workflow-preset behavior into queue routes so preset application and admin-default precedence are reliable on page load and selection.

Purpose: Convert service-layer policy into deterministic route behavior for all four required moderation contexts.
Output: Route + toolbar wiring and integration tests validating apply semantics, precedence, and tolerant stale apply.
</objective>

<execution_context>
@/home/n501/.config/opencode/get-shit-done/workflows/execute-plan.md
@/home/n501/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-workflow-presets/02-CONTEXT.md
@.planning/phases/02-workflow-presets/02-RESEARCH.md
@.planning/phases/02-workflow-presets/02-01-PLAN.md
@app/web/main.py
@app/web/dense_list.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add preset-aware route load and action endpoints</name>
  <files>app/web/main.py</files>
  <action>Update `complaints`, `appeals`, `signals`, and `trade_feedback` queue routes to load preset state via the new service and apply deterministic precedence: admin default only on first entry, otherwise last-selected preset. Add CSRF-protected JSON actions for save-as-new, update-current, apply/select, delete, set admin default, and reset-to-admin-default. Ensure owner/admin authorization is enforced server-side and unauthorized operations return 403.</action>
  <verify>RUN_INTEGRATION_TESTS=1 TEST_DATABASE_URL=postgresql+asyncpg://.../auction_test python -m pytest -q tests/integration/test_web_workflow_presets.py -k "auth or default or select or reset"</verify>
  <done>All required queue routes expose consistent preset actions with deterministic load precedence and RBAC-safe failures.</done>
</task>

<task type="auto">
  <name>Task 2: Extend dense-list render contract for preset metadata and notices</name>
  <files>app/web/dense_list.py</files>
  <action>Extend dense-list helpers to emit preset selector data, active preset identity, modified baseline snapshot, and transient notice hooks used when stale preset parameters are skipped. Keep output deterministic and queue-agnostic so future contexts can reuse the same script contract without route-specific DOM branching.</action>
  <verify>python -m pytest -q tests/test_web_dense_list_contract.py -k "preset or dense"</verify>
  <done>Rendered queue pages expose all data hooks required for immediate apply, modified detection, and stale-parameter notices.</done>
</task>

<task type="auto">
  <name>Task 3: Add integration tests for precedence and tolerant apply</name>
  <files>tests/integration/test_web_workflow_presets.py</files>
  <action>Create DB-backed integration tests proving first-entry admin default auto-apply, subsequent open uses last-selected preset, reset-to-admin-default returns expected state, and stale preset payloads apply valid fields while returning a short notice. Include all four context mappings (`moderation->complaints`, `appeals->appeals`, `risk->signals`, `feedback->trade_feedback`).</action>
  <verify>RUN_INTEGRATION_TESTS=1 TEST_DATABASE_URL=postgresql+asyncpg://.../auction_test python -m pytest -q tests/integration/test_web_workflow_presets.py</verify>
  <done>Integration suite confirms deterministic precedence and tolerant apply behavior for all required contexts.</done>
</task>

</tasks>

<verification>
Run workflow preset integration tests against a dedicated test DB and ensure route-level authorization/precedence paths pass.
</verification>

<success_criteria>
Preset loading/apply behavior is deterministic and resilient, with route contracts enforcing the first-entry/default/last-selected policy across required queue contexts.
</success_criteria>

<output>
After completion, create `.planning/phases/02-workflow-presets/02-workflow-presets-02-SUMMARY.md`
</output>
