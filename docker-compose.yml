services:
  db:
    image: postgres:16-alpine
    container_name: liteauction-db
    restart: unless-stopped
    environment:
      POSTGRES_DB: ${POSTGRES_DB:-auction}
      POSTGRES_USER: ${POSTGRES_USER:-auction}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-auction}
    volumes:
      - ./data/postgres:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-auction} -d ${POSTGRES_DB:-auction}"]
      interval: 5s
      timeout: 5s
      retries: 10

  redis:
    image: redis:7-alpine
    container_name: liteauction-redis
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 3s
      retries: 10

  bot:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: liteauction-bot
    restart: unless-stopped
    environment:
      BOT_TOKEN: ${BOT_TOKEN:-replace_me}
      BOT_USERNAME: ${BOT_USERNAME:-}
      DATABASE_URL: ${DATABASE_URL:-postgresql+asyncpg://auction:auction@db:5432/auction}
      REDIS_URL: ${REDIS_URL:-redis://redis:6379/0}
      TZ: ${TZ:-Asia/Tashkent}
      LOG_LEVEL: ${LOG_LEVEL:-INFO}
      ADMIN_USER_IDS: ${ADMIN_USER_IDS:-}
      ADMIN_OPERATOR_USER_IDS: ${ADMIN_OPERATOR_USER_IDS:-}
      MODERATION_CHAT_ID: ${MODERATION_CHAT_ID:-}
      MODERATION_THREAD_ID: ${MODERATION_THREAD_ID:-}
      MODERATION_TOPIC_COMPLAINTS_ID: ${MODERATION_TOPIC_COMPLAINTS_ID:-}
      MODERATION_TOPIC_SUGGESTIONS_ID: ${MODERATION_TOPIC_SUGGESTIONS_ID:-}
      MODERATION_TOPIC_BUGS_ID: ${MODERATION_TOPIC_BUGS_ID:-}
      MODERATION_TOPIC_GUARANTORS_ID: ${MODERATION_TOPIC_GUARANTORS_ID:-}
      MODERATION_TOPIC_APPEALS_ID: ${MODERATION_TOPIC_APPEALS_ID:-}
      MODERATION_TOPIC_AUCTIONS_ACTIVE_ID: ${MODERATION_TOPIC_AUCTIONS_ACTIVE_ID:-}
      MODERATION_TOPIC_AUCTIONS_FROZEN_ID: ${MODERATION_TOPIC_AUCTIONS_FROZEN_ID:-}
      MODERATION_TOPIC_AUCTIONS_CLOSED_ID: ${MODERATION_TOPIC_AUCTIONS_CLOSED_ID:-}
      ADMIN_PANEL_TOKEN: ${ADMIN_PANEL_TOKEN:-}
      ADMIN_WEB_SESSION_SECRET: ${ADMIN_WEB_SESSION_SECRET:-}
      ADMIN_WEB_AUTH_MAX_AGE_SECONDS: ${ADMIN_WEB_AUTH_MAX_AGE_SECONDS:-86400}
      ADMIN_WEB_COOKIE_SECURE: ${ADMIN_WEB_COOKIE_SECURE:-false}
      ADMIN_WEB_CSRF_TTL_SECONDS: ${ADMIN_WEB_CSRF_TTL_SECONDS:-7200}
      UI_EMOJI_CREATE_AUCTION_ID: ${UI_EMOJI_CREATE_AUCTION_ID:-}
      UI_EMOJI_PUBLISH_ID: ${UI_EMOJI_PUBLISH_ID:-}
      UI_EMOJI_BID_ID: ${UI_EMOJI_BID_ID:-}
      UI_EMOJI_BUYOUT_ID: ${UI_EMOJI_BUYOUT_ID:-}
      UI_EMOJI_REPORT_ID: ${UI_EMOJI_REPORT_ID:-}
      UI_EMOJI_MOD_PANEL_ID: ${UI_EMOJI_MOD_PANEL_ID:-}
      ANTI_SNIPER_WINDOW_MINUTES: ${ANTI_SNIPER_WINDOW_MINUTES:-2}
      ANTI_SNIPER_EXTEND_MINUTES: ${ANTI_SNIPER_EXTEND_MINUTES:-3}
      ANTI_SNIPER_MAX_EXTENSIONS: ${ANTI_SNIPER_MAX_EXTENSIONS:-3}
      BID_COOLDOWN_SECONDS: ${BID_COOLDOWN_SECONDS:-2}
      DUPLICATE_BID_WINDOW_SECONDS: ${DUPLICATE_BID_WINDOW_SECONDS:-15}
      CONFIRMATION_TTL_SECONDS: ${CONFIRMATION_TTL_SECONDS:-5}
      COMPLAINT_COOLDOWN_SECONDS: ${COMPLAINT_COOLDOWN_SECONDS:-60}
      SOFT_GATE_REQUIRE_PRIVATE_START: ${SOFT_GATE_REQUIRE_PRIVATE_START:-true}
      SOFT_GATE_MODE: ${SOFT_GATE_MODE:-grace}
      SOFT_GATE_HINT_INTERVAL_HOURS: ${SOFT_GATE_HINT_INTERVAL_HOURS:-24}
      AUCTION_WATCHER_INTERVAL_SECONDS: ${AUCTION_WATCHER_INTERVAL_SECONDS:-5}
      FRAUD_ALERT_THRESHOLD: ${FRAUD_ALERT_THRESHOLD:-60}
      FRAUD_RAPID_WINDOW_SECONDS: ${FRAUD_RAPID_WINDOW_SECONDS:-120}
      FRAUD_RAPID_MIN_BIDS: ${FRAUD_RAPID_MIN_BIDS:-5}
      FRAUD_DOMINANCE_WINDOW_SECONDS: ${FRAUD_DOMINANCE_WINDOW_SECONDS:-300}
      FRAUD_DOMINANCE_MIN_TOTAL_BIDS: ${FRAUD_DOMINANCE_MIN_TOTAL_BIDS:-8}
      FRAUD_DOMINANCE_RATIO: ${FRAUD_DOMINANCE_RATIO:-0.7}
      FRAUD_DUOPOLY_WINDOW_SECONDS: ${FRAUD_DUOPOLY_WINDOW_SECONDS:-300}
      FRAUD_DUOPOLY_MIN_TOTAL_BIDS: ${FRAUD_DUOPOLY_MIN_TOTAL_BIDS:-10}
      FRAUD_DUOPOLY_PAIR_RATIO: ${FRAUD_DUOPOLY_PAIR_RATIO:-0.85}
      FRAUD_ALTERNATING_RECENT_BIDS: ${FRAUD_ALTERNATING_RECENT_BIDS:-8}
      FRAUD_ALTERNATING_MIN_SWITCHES: ${FRAUD_ALTERNATING_MIN_SWITCHES:-6}
      FRAUD_BASELINE_WINDOW_SECONDS: ${FRAUD_BASELINE_WINDOW_SECONDS:-3600}
      FRAUD_BASELINE_MIN_BIDS: ${FRAUD_BASELINE_MIN_BIDS:-6}
      FRAUD_BASELINE_SPIKE_FACTOR: ${FRAUD_BASELINE_SPIKE_FACTOR:-4.0}
      FRAUD_BASELINE_MIN_INCREMENT: ${FRAUD_BASELINE_MIN_INCREMENT:-50}
      FRAUD_BASELINE_SPIKE_SCORE: ${FRAUD_BASELINE_SPIKE_SCORE:-25}
      FRAUD_HISTORICAL_COMPLETED_AUCTIONS: ${FRAUD_HISTORICAL_COMPLETED_AUCTIONS:-30}
      FRAUD_HISTORICAL_MIN_POINTS: ${FRAUD_HISTORICAL_MIN_POINTS:-25}
      FRAUD_HISTORICAL_SPIKE_FACTOR: ${FRAUD_HISTORICAL_SPIKE_FACTOR:-3.0}
      FRAUD_HISTORICAL_MIN_INCREMENT: ${FRAUD_HISTORICAL_MIN_INCREMENT:-40}
      FRAUD_HISTORICAL_SPIKE_SCORE: ${FRAUD_HISTORICAL_SPIKE_SCORE:-20}
      FRAUD_HISTORICAL_START_RATIO_LOW: ${FRAUD_HISTORICAL_START_RATIO_LOW:-0.5}
      FRAUD_HISTORICAL_START_RATIO_HIGH: ${FRAUD_HISTORICAL_START_RATIO_HIGH:-2.0}
      FEEDBACK_INTAKE_MIN_LENGTH: ${FEEDBACK_INTAKE_MIN_LENGTH:-10}
      FEEDBACK_INTAKE_COOLDOWN_SECONDS: ${FEEDBACK_INTAKE_COOLDOWN_SECONDS:-90}
      FEEDBACK_BUG_REWARD_POINTS: ${FEEDBACK_BUG_REWARD_POINTS:-30}
      FEEDBACK_SUGGESTION_REWARD_POINTS: ${FEEDBACK_SUGGESTION_REWARD_POINTS:-20}
      GITHUB_AUTOMATION_ENABLED: ${GITHUB_AUTOMATION_ENABLED:-false}
      GITHUB_TOKEN: ${GITHUB_TOKEN:-}
      GITHUB_REPO_OWNER: ${GITHUB_REPO_OWNER:-Nombah501}
      GITHUB_REPO_NAME: ${GITHUB_REPO_NAME:-LiteAuction}
      OUTBOX_WATCHER_INTERVAL_SECONDS: ${OUTBOX_WATCHER_INTERVAL_SECONDS:-20}
      OUTBOX_BATCH_SIZE: ${OUTBOX_BATCH_SIZE:-20}
      OUTBOX_MAX_ATTEMPTS: ${OUTBOX_MAX_ATTEMPTS:-5}
      OUTBOX_RETRY_BASE_SECONDS: ${OUTBOX_RETRY_BASE_SECONDS:-30}
      OUTBOX_RETRY_MAX_SECONDS: ${OUTBOX_RETRY_MAX_SECONDS:-1800}
      FEEDBACK_GITHUB_ACTOR_TG_USER_ID: ${FEEDBACK_GITHUB_ACTOR_TG_USER_ID:-998}
    depends_on:
      db:
        condition: service_healthy
      redis:
        condition: service_healthy
    dns:
      - 1.1.1.1
      - 8.8.8.8
    command: sh -c "alembic upgrade head && python -m app.main"
    healthcheck:
      test: ["CMD-SHELL", "python -m app.healthcheck"]
      interval: 30s
      timeout: 10s
      retries: 3

  admin:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: liteauction-admin
    restart: unless-stopped
    environment:
      BOT_TOKEN: ${BOT_TOKEN:-replace_me}
      BOT_USERNAME: ${BOT_USERNAME:-}
      DATABASE_URL: ${DATABASE_URL:-postgresql+asyncpg://auction:auction@db:5432/auction}
      TZ: ${TZ:-Asia/Tashkent}
      ADMIN_PANEL_TOKEN: ${ADMIN_PANEL_TOKEN:-}
      ADMIN_USER_IDS: ${ADMIN_USER_IDS:-}
      ADMIN_OPERATOR_USER_IDS: ${ADMIN_OPERATOR_USER_IDS:-}
      MODERATION_CHAT_ID: ${MODERATION_CHAT_ID:-}
      MODERATION_THREAD_ID: ${MODERATION_THREAD_ID:-}
      MODERATION_TOPIC_COMPLAINTS_ID: ${MODERATION_TOPIC_COMPLAINTS_ID:-}
      MODERATION_TOPIC_SUGGESTIONS_ID: ${MODERATION_TOPIC_SUGGESTIONS_ID:-}
      MODERATION_TOPIC_BUGS_ID: ${MODERATION_TOPIC_BUGS_ID:-}
      MODERATION_TOPIC_GUARANTORS_ID: ${MODERATION_TOPIC_GUARANTORS_ID:-}
      MODERATION_TOPIC_APPEALS_ID: ${MODERATION_TOPIC_APPEALS_ID:-}
      MODERATION_TOPIC_AUCTIONS_ACTIVE_ID: ${MODERATION_TOPIC_AUCTIONS_ACTIVE_ID:-}
      MODERATION_TOPIC_AUCTIONS_FROZEN_ID: ${MODERATION_TOPIC_AUCTIONS_FROZEN_ID:-}
      MODERATION_TOPIC_AUCTIONS_CLOSED_ID: ${MODERATION_TOPIC_AUCTIONS_CLOSED_ID:-}
      FEEDBACK_INTAKE_MIN_LENGTH: ${FEEDBACK_INTAKE_MIN_LENGTH:-10}
      FEEDBACK_INTAKE_COOLDOWN_SECONDS: ${FEEDBACK_INTAKE_COOLDOWN_SECONDS:-90}
      FEEDBACK_BUG_REWARD_POINTS: ${FEEDBACK_BUG_REWARD_POINTS:-30}
      FEEDBACK_SUGGESTION_REWARD_POINTS: ${FEEDBACK_SUGGESTION_REWARD_POINTS:-20}
      GITHUB_AUTOMATION_ENABLED: ${GITHUB_AUTOMATION_ENABLED:-false}
      GITHUB_REPO_OWNER: ${GITHUB_REPO_OWNER:-Nombah501}
      GITHUB_REPO_NAME: ${GITHUB_REPO_NAME:-LiteAuction}
      OUTBOX_BATCH_SIZE: ${OUTBOX_BATCH_SIZE:-20}
      OUTBOX_MAX_ATTEMPTS: ${OUTBOX_MAX_ATTEMPTS:-5}
      OUTBOX_RETRY_BASE_SECONDS: ${OUTBOX_RETRY_BASE_SECONDS:-30}
      OUTBOX_RETRY_MAX_SECONDS: ${OUTBOX_RETRY_MAX_SECONDS:-1800}
      FEEDBACK_GITHUB_ACTOR_TG_USER_ID: ${FEEDBACK_GITHUB_ACTOR_TG_USER_ID:-998}
      ADMIN_WEB_SESSION_SECRET: ${ADMIN_WEB_SESSION_SECRET:-}
      ADMIN_WEB_AUTH_MAX_AGE_SECONDS: ${ADMIN_WEB_AUTH_MAX_AGE_SECONDS:-86400}
      ADMIN_WEB_COOKIE_SECURE: ${ADMIN_WEB_COOKIE_SECURE:-false}
      ADMIN_WEB_CSRF_TTL_SECONDS: ${ADMIN_WEB_CSRF_TTL_SECONDS:-7200}
    depends_on:
      db:
        condition: service_healthy
    dns:
      - 1.1.1.1
      - 8.8.8.8
    command: sh -c "python -m app.web.main"
    ports:
      - "8080:8080"
