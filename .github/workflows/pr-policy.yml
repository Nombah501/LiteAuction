name: PR Policy

on:
  pull_request:
    types: [opened, edited, synchronize, reopened, labeled, unlabeled, ready_for_review]

jobs:
  validate-policy:
    name: Validate PR policy
    runs-on: ubuntu-latest
    permissions:
      pull-requests: read
    steps:
      - name: Check linked issue and sprint label
        uses: actions/github-script@v7
        with:
          script: |
            const pr = context.payload.pull_request;
            if (!pr) {
              core.setFailed("No pull request payload available.");
              return;
            }

            const body = pr.body || "";
            const labels = (pr.labels || []).map((label) => String(label.name || ""));
            const sprintLabels = labels.filter((label) =>
              label.toLowerCase().startsWith("sprint:")
            );

            const closesIssuePattern =
              /\b(?:close[sd]?|fix(?:e[sd])?|resolve[sd]?)\s+(?:#\d+|https:\/\/github\.com\/[^\s/]+\/[^\s/]+\/issues\/\d+)\b/i;

            const failures = [];
            if (!closesIssuePattern.test(body)) {
              failures.push(
                "PR body must include a linked issue, for example `Closes #123`."
              );
            }
            if (sprintLabels.length === 0) {
              failures.push("PR must include at least one label prefixed with `sprint:`.");
            }

            if (failures.length > 0) {
              core.setFailed(failures.join("\n"));
              return;
            }

            core.info(`Policy checks passed. Sprint labels: ${sprintLabels.join(", ")}`);
